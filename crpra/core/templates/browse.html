{% extends "base.html" %}
{% block title %} {{ title }} {% endblock %}

{% block styles %}
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
{% block scripts %}
        <script src="./static/js/leaflet.ajax.min.js"></script>
{% endblock %}

{% block content %}
        <script type="text/javascript" src="./static/js/Leaflet.heat/dist/leaflet-heat.js"></script>

<div id="container">
<h2>Deputy records by gang affiliation</h2>
<p>Click on a gang to see the list of associated deputies and view the associated shootings on the map.
    <h3>Gangs<a name="gangs"></a></h3>
<div id="cols"> 
    <div style="width: 15%;">
    <div class="groupboxes">
        {% for g in gangs %}
            <div class="box" id="{{ g }}"><a href="#gangs" onClick="fetchGang('{{ g }}')">{{ g }}</a></div>
        {% endfor %}
    </div>
    </div>
    <div id="displaypanel" style="width: 45%;padding:0 20px;"></div>
    <div id="map" style="float:right;width: 50%;"></div>

<script type="module">
import { shootingPull } from './static/js/data.js';
var map = L.map('map',{
            maxZoom: 15,
            minZoom: 8,
            zoomControl: false}).setView([34.25, -118.21], 9);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 15,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
var markersGroup = L.layerGroup().addTo(map);
async function fetchGang(name) {
    markersGroup.clearLayers();
    let boxes = document.querySelectorAll('.box');

    // Loop through each element and set its background color to white
    boxes.forEach(box => {
        box.style.backgroundColor = 'white';
    });
    document.getElementById(name).style.backgroundColor = 'lightblue';
    try {
        const response = await fetch('/gang-json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ gang: name }),
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        let temp = null;
        let dataH = data.map(d => "<li><a href='deputy/" + d + "'>" + d + "</a></li>");
        dataH = dataH.join(""); 
        let innerH = "<ul>" + dataH + "</ul>";
        document.getElementById("displaypanel").innerHTML = innerH;
        for (let d of data) {
            temp = await shootingPull(null, null, null, d, null, null, null);
            for (let t of temp) {
                if (t.lat && t.lng) {
                    let marker = L.marker([t.lat, t.lng]);
                    marker.bindPopup("<a href='shooting/" + t.victim + "'>Shooting of " + t.victim + " by " + t.officer + "</a>").openTooltip();
                    markersGroup.addLayer(marker);
                }
            }
        }
    } catch (error) {
        console.error('Error fetching gang data:', error);
        throw error; // Re-throw the error for further handling if needed
    }
}
window.fetchGang = fetchGang;
fetchGang("3000 Boys");
</script>
</div>
</div>

{% endblock %}

